<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestor de Cómics con Firebase</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    input, select, button { margin-top: 5px; display: block; }
    .estado-realizado { color: orange; }
    .estado-tienda { color: steelblue; }
    .estado-recibido { color: seagreen; }
    .coleccion { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 10px; }
    .coleccion h3 { margin-bottom: 10px; }
    .coleccion h4 { margin-bottom: 5px; margin-left: 20px; }
    .item-editable { margin-left: 20px; }
    .botones-editar-eliminar { display: inline-block; margin-left: 10px; }
  </style>
</head>
<body>

  <h1>Gestor de Cómics con Firebase</h1>

  <div id="loginDiv">
    <button id="btnLogin">Entrar con Google</button>
  </div>

  <div id="app" style="display:none;">
    <h2>Agregar cómic</h2>

    <label>Editorial:
      <select id="editorial" onchange="handleNuevo(this)">
        <option value="">Selecciona...</option>
        <option value="__nuevo">Nuevo...</option>
      </select>
      <input type="text" id="editorialNuevo" placeholder="Escribe nueva editorial" style="display:none;" />
    </label>

    <label>Título:
      <select id="titulo" onchange="handleNuevo(this)">
        <option value="">Selecciona...</option>
        <option value="__nuevo">Nuevo...</option>
      </select>
      <input type="text" id="tituloNuevo" placeholder="Escribe nuevo título" style="display:none;" />
    </label>

    <label>Número:
      <input type="number" id="numero" min="1" />
    </label>

    <label>De (total de números):
      <input type="text" id="total" placeholder="Número total o dejar vacío/indefinido" />
    </label>

    <label>Fecha de pedido:
      <input type="date" id="fecha" />
    </label>

    <label>Estado del pedido:
      <select id="estado">
        <option value="">Selecciona...</option>
        <option value="realizado">Pedido realizado</option>
        <option value="tienda">Pedido en tienda</option>
        <option value="recibido">Pedido recibido</option>
      </select>
    </label>

    <button onclick="agregarComic()">Agregar cómic</button>

    <h3>Lista de cómics por editorial y colección</h3>
    <div id="lista"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Tu configuración Firebase aquí (reemplaza con la tuya)
    const firebaseConfig = {
  apiKey: "AIzaSyD5hasVRtSOEzMffIZqR3hnBj3Q2G0XTVU",
  authDomain: "gestor-comics.firebaseapp.com",
  projectId: "gestor-comics",
  storageBucket: "gestor-comics.firebasestorage.app",
  messagingSenderId: "90236265815",
  appId: "1:90236265815:web:ee35129488954958470a12"
};

    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginDiv = document.getElementById("loginDiv");
    const appDiv = document.getElementById("app");
    const btnLogin = document.getElementById("btnLogin");

    btnLogin.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    auth.onAuthStateChanged(user => {
      if (user) {
        loginDiv.style.display = "none";
        appDiv.style.display = "block";
        cargarDatos();
        ponerFechaHoy();
      } else {
        loginDiv.style.display = "block";
        appDiv.style.display = "none";
      }
    });

    function ponerFechaHoy() {
      const fechaInput = document.getElementById("fecha");
      const hoy = new Date().toISOString().split('T')[0];
      fechaInput.value = hoy;
    }

    // Opciones para los selects guardadas aquí
    let opciones = { editorial: [], titulo: [] };

    function handleNuevo(select) {
      const input = document.getElementById(select.id + "Nuevo");
      if (select.value === "__nuevo") {
        input.style.display = "block";
        input.focus();
      } else {
        input.style.display = "none";
      }
    }

    function agregarOpcion(campo, valor) {
      if (!opciones[campo].includes(valor)) {
        opciones[campo].push(valor);
        actualizarSelect(campo);
      }
    }

    function actualizarSelect(campo) {
      const select = document.getElementById(campo);
      const inputNuevo = document.getElementById(campo + "Nuevo");
      const valorActual = select.value;

      // Limpiar opciones excepto "Selecciona..." y "Nuevo..."
      select.innerHTML = `<option value="">Selecciona...</option><option value="__nuevo">Nuevo...</option>`;

      opciones[campo].forEach(opt => {
        const option = document.createElement("option");
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });

      select.value = valorActual || "";
      inputNuevo.style.display = "none";
    }

    function obtenerValorSelectConNuevo(campo) {
      const select = document.getElementById(campo);
      let valor = select.value;
      const inputNuevo = document.getElementById(campo + "Nuevo");
      if (valor === "__nuevo") {
        valor = inputNuevo.value.trim();
        if (!valor) {
          alert("Por favor escribe un valor para el campo nuevo.");
          throw new Error("Campo nuevo vacío");
        }
        inputNuevo.value = "";
        inputNuevo.style.display = "none";
      }
      return valor;
    }

    // Agregar cómic a Firestore
    async function agregarComic() {
      try {
        let editorial = obtenerValorSelectConNuevo("editorial");
        let titulo = obtenerValorSelectConNuevo("titulo");

        const numero = document.getElementById("numero").value;
        const totalRaw = document.getElementById("total").value.trim();
        const fecha = document.getElementById("fecha").value;
        const estado = document.getElementById("estado").value;

        if (!editorial || !titulo || !numero || !fecha || !estado) {
          alert("Completa los campos obligatorios (editorial, título, número, fecha, estado).");
          return;
        }

        let total = totalRaw.toLowerCase();
        if (total === "") total = "indefinido";
        else if (total !== "indefinido" && isNaN(total)) {
          alert("El campo 'De (total de números)' debe estar vacío, ser 'indefinido' o un número válido.");
          return;
        }

        agregarOpcion("editorial", editorial);
        agregarOpcion("titulo", titulo);

        // Guardar en Firestore
        await db.collection("comics").add({
          editorial,
          titulo,
          numero: Number(numero),
          total,
          fecha,
          estado,
          uid: auth.currentUser.uid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        limpiarCampos();
      } catch (e) {
        console.error(e);
      }
    }

    function limpiarCampos() {
      document.getElementById("numero").value = "";
      document.getElementById("total").value = "";
      document.getElementById("estado").value = "";
      ponerFechaHoy();
    }

    // Cargar datos y mostrar agrupados
    function cargarDatos() {
      // Limpiar opciones y lista
      opciones.editorial = [];
      opciones.titulo = [];
      actualizarSelect("editorial");
      actualizarSelect("titulo");

      db.collection("comics")
        .where("uid", "==", auth.currentUser.uid)
        .orderBy("createdAt")
        .onSnapshot(snapshot => {
          const lista = document.getElementById("lista");
          lista.innerHTML = "";

          const datos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

          // Actualizar opciones
          datos.forEach(item => {
            if (!opciones.editorial.includes(item.editorial)) opciones.editorial.push(item.editorial);
            if (!opciones.titulo.includes(item.titulo)) opciones.titulo.push(item.titulo);
          });

          actualizarSelect("editorial");
          actualizarSelect("titulo");

          // Agrupar por editorial y título
          const agrupado = {};
          datos.forEach(item => {
            if (!agrupado[item.editorial]) agrupado[item.editorial] = {};
            if (!agrupado[item.editorial][item.titulo]) agrupado[item.editorial][item.titulo] = [];
            agrupado[item.editorial][item.titulo].push(item);
          });

          for (const editorial in agrupado) {
            const divEd = document.createElement("div");
            divEd.classList.add("coleccion");

            const h3 = document.createElement("h3");
            h3.textContent = editorial;
            divEd.appendChild(h3);

            for (const titulo in agrupado[editorial]) {
              const divTi = document.createElement("div");
              divTi.classList.add("coleccion");

              const h4 = document.createElement("h4");
              h4.textContent = titulo;
              divTi.appendChild(h4);

              agrupado[editorial][titulo].forEach(item => {
                const p = document.createElement("p");
                p.classList.add("item-editable");
                p.innerHTML = `
                  Nº ${item.numero} de ${item.total} - Fecha: ${item.fecha} - 
                  <span class="estado-${item.estado}" style="font-weight:bold;">${estadoTexto(item.estado)}</span>
                  <span class="botones-editar-eliminar">
                    <button onclick="editarComic('${item.id}')">Editar</button>
                    <button onclick="eliminarComic('${item.id}')">Eliminar</button>
                  </span>
                `;
                divTi.appendChild(p);
              });

              divEd.appendChild(divTi);
            }

            lista.appendChild(divEd);
          }
        });
    }

    function estadoTexto(estado) {
      if (estado === "realizado") return "Pedido realizado";
      if (estado === "tienda") return "Pedido en tienda";
      if (estado === "recibido") return "Pedido recibido";
      return estado;
    }

    // Eliminar cómic
    async function eliminarComic(id) {
      if (confirm("¿Seguro que quieres eliminar este cómic?")) {
        await db.collection("comics").doc(id).delete();
      }
    }

    // Editar cómic (simplificado: carga datos en formulario y elimina el original)
    async function editarComic(id) {
      const doc = await db.collection("comics").doc(id).get();
      if (!doc.exists) {
        alert("No se encontró el cómic.");
        return;
      }
      const data = doc.data();

      // Cargar en formulario
      document.getElementById("editorial").value = data.editorial;
      document.getElementById("titulo").value = data.titulo;
      document.getElementById("numero").value = data.numero;
      document.getElementById("total").value = data.total === "indefinido" ? "" : data.total;
      document.getElementById("fecha").value = data.fecha;
      document.getElementById("estado").value = data.estado;

      // Eliminar el original para que cuando guardes sea como nuevo
      await db.collection("comics").doc(id).delete();
    }

  </script>

</body>
</html>
